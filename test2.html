<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Home control system | Igor Zakutynsky</title>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <link rel="stylesheet" type="text/css" href="css/concat.css"/>
   <link rel="stylesheet" href="dist/switchery.css" />
   <script src="dist/switchery.js"></script>
</head>

<body>
	<div class="container test">
		<div class="row">
			<div class="col-md-6 col-md-offset-3">
				<h3>Система домашнього контролю | <small>Ігор Закутинський</small></h3>
				<div class="panel panel-primary"> 
					<div class="panel-heading"> 
						<h3 class="panel-title">Поточна вологість:</h3> 
					</div> 

					<div class="panel-body"> 
						<div class="progress">
							<div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 50%;">
								50%
							</div>
						</div>
					</div> 
				</div>

				<div class="panel panel-primary"> 
					<div class="panel-heading"> 
						<h3 class="panel-title">Температура:</h3> 
					</div> 

					
					<div class="panel-body"> 
						<div class="row">
							<div class="col-md-4  col-md-offset-4 icon-block">
								<i class="wi wi-thermometer"></i>
							</div>
							
						</div>
						<div class="row">
							<div class="col-md-4 col-md-offset-4 col-sm-4 col-sm-offset-4 temp-block">
								<span> 22 </span>
								<i class="wi wi-celsius"></i>
							</div>
						</div>
					</div> 
				</div>

				<div class="panel panel-primary"> 
					<div class="panel-heading"> 
						<h3 class="panel-title">Поливати при:</h3> 
					</div> 
					<div class="panel-body"> 
						<div class="slider-wrapper">
							<input type="text" class="js-customized" />
						</div>

						<div class="panel panel-default">
							<div class="panel-body value-text">

							</div>
						</div>
						<button type="button" class="btn btn-primary go">Застосувати</button>
                        <br>
                        <br>
                    </div> 

                </div>

                <div class="panel panel-primary"> 
                    <div class="panel-heading"> 
                        <h3 class="panel-title">Освітлення | LED:</h3> 
                    </div> 
                    <div class="panel-body"> 
                        <input type="checkbox" id="led" class="js-switch"/>
                    </div> 

                </div>

                <button type="button" class="btn btn-primary btn-lg btn-block test" >Led!</button>

                <br>
                <div class="state"></div>
                <br>

            </div>
        </div>
    </div>
    <script src="libs/jquery.js"></script>
    <script src="dist/js/bootstrap.min.js"></script>
    <script src="dist/js/mqtt_lib.js"></script>
    <script src="dist/powerange.js"></script>
    <script type="text/javascript">

    // Basic customization.
    var cust = document.querySelector('.js-customized');
    var initCust = new Powerange(cust, { hideRange: true, klass: 'power-ranger', start: 40 });
    var elem = document.querySelector('.js-switch');
    var init = new Switchery(elem);
    
    function onChange(el) {
        if (typeof Event === 'function' || !document.fireEvent) {
            var event = document.createEvent('HTMLEvents');
            event.initEvent('change', true, true);
            el.dispatchEvent(event);
        } else {
            el.fireEvent('onchange');
        }
    }
    
    $(document).ready(function(){
    	$(".value-text").html($(".js-customized").val() + "%");
    	
        $(".js-customized").change(function(){
          $(".value-text").html($(".js-customized").val() + "%");
      })

        $("#led").change(function(){
         if($("#led").prop("checked")==true){
             message = new Paho.MQTT.Message("1");
         }
         else if($("#led").prop("checked")==false){
             message = new Paho.MQTT.Message("0");
         }
         message.destinationName = "state";
         message.retained = true;
         client.send(message);


     })

        $(".test").click(function(){
            var event = document.createEvent('HTMLEvents');
            event.initEvent('change', true, true);
            elem.dispatchEvent(event);
        })

        $(".go").click(function(){
          message = new Paho.MQTT.Message($(".js-customized").val());
          message.destinationName = "state";
          message.retained = true;
          client.send(message);
          console.log($(".js-customized").val());
      })



        // called when the client connects
        function onConnect() {
          // Once a connection has been made, make a subscription and send a message.
          console.log("onConnect");
          client.subscribe("state"); //назва топіка
          client.subscribe("temp");
      }

        // called when the client loses its connection
        function onConnectionLost(responseObject) {
        	if (responseObject.errorCode !== 0) {
        		console.log("onConnectionLost:", responseObject.errorMessage);
        		setTimeout(function() { client.connect() }, 5000);
        	}
        }
        
        // called when a message arrives
        function onMessageArrived(message) {


        	if(message.destinationName == "state")
        	{
                $(".state").html(message.payloadString);
        	}
        	if(message.destinationName == "temp")
        	{
        		$(".temp-block span").html(message.payloadString);
        	}

           

        }
        
        function onFailure(invocationContext, errorCode, errorMessage) {
        	var errDiv = document.getElementById("error");
        	errDiv.textContent = "Could not connect to WebSocket server, most likely you're behind a firewall that doesn't allow outgoing connections to port 37501";
        	errDiv.style.display = "block";
        }
        
        var clientId = "ws" + Math.random();
        // Create a client instance
        var client = new Paho.MQTT.Client("m21.cloudmqtt.com", 37501, clientId);
        
        // set callback handlers
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;
        
        // connect the client
        client.connect({
        	useSSL: true,
        	userName: "vepowdjb",
        	password: "qLI6_0KJ7YTu",
        	onSuccess: onConnect,
        	onFailure: onFailure
        });




    })

</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-78574609-1', 'auto');
  ga('send', 'pageview');

</script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter37670530 = new Ya.Metrika({
                    id:37670530,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true
                });
            } catch(e) { }
        });

        var n = d.getElementsByTagName("script")[0],
            s = d.createElement("script"),
            f = function () { n.parentNode.insertBefore(s, n); };
        s.type = "text/javascript";
        s.async = true;
        s.src = "https://mc.yandex.ru/metrika/watch.js";

        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else { f(); }
    })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/37670530" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

</body>
</html>
